# 하나의 단위로 데이터를 처리하는 트랜잭션
## 트랜잭션이란 ?
> 트랜잭션의 필요성을 알기
```
A계좌에서 B계좌로 100만원을 이체한다면
`
전제조건 A계좌에는 100만원이 잔고에 있고
        B계좌에는     0원이 잔고에 있다
`

1. A 계좌의 잔액 변경
2. B 계좌의 잔액 변경


SQL문
-
1.A 계좌 잔액을 0원으로 변경하는 UPDATE문 실행
    UPDATE ACCOUNT
        SET BALANCE = 0
    WHERE ACCNO = A계번호;
2.B 계좌 잔액을 100만원으로 변경하는 UPDATE문 실행
    UPDATE ACCOUNT
        SET BALANCE = 1000000
    WHERE ACCNO = B계좌번호;
`

1번을 실행하고 2번을 실행하려는 중간에
데이터베이스가 갑작스럽게 2번을 실행을 못한다면
A계좌는 0원,B계좌도 0원이 되고 100만원은 오류로 사라진다.

따라서 위 작업은 하나가 되어야 하고
둘다 실행이 되는 것 , 둘다 실행이 되지 않는 것으로 나뉜다.

```
> 트랜잭션이란
## __`더이상 분해할 수 없는 최소 수행 단위`__   
```
한개 이상의 데이터 조작 명령어(DML)로 이루어진다.
SQL문 덩어리 라고 볼수도있다.

트랜잭션은 하나의 트랜잭션내의 여러 명령어(DML)이 한번에 수행하여

1.모두 완료
2.모두 미실행

트랜잭션은 ALL OR NOTHING 이라고 한다.

```
> 트랜잭션을 제어하가 위한 명령어   

`TCL(Transaction Control Language)`
```
트랜잭션은 데이터베이스 계정에 접속하는 동시에 시작된다

트랜잭션이 종료되기 전까지 여러 SQL문을 실행하고 

트랜잭션을 제어하는 명령(TCL)을 실행할때

기존 트랜잭션이 끝이난다.

그후 새로운 트랜잭션이 실행이 되는 과정을 거친다.

음식점에서 영수증이 나오는 느낌과 비슷하다
하나의 영수증이 다 완성되거나 나오지 않거나
```
## 트랜잭션을 제어하는 명령어
```
트랜잭션 제어 명령어는

데이터 베이스 명령어를 완료하거나 작업 전체를 취소하거나

둘중 하나를 유도한다.
```

### _`트랜잭션을 취소하고 싶을때는 ROLLBACK`_
> 데이터 조작중이면 하나의 트랜잭션에 속했있고   
이 모든 작업을 취소를 하고 싶다면
```
ROLLBACK;
```

### `트랜잭션을 영원히 반영하고 싶을땐 COMMIT`
> 여러 DML을 완료할때는 COMMIT으로 저장한다.
```
COMMIT;
```
> COMMIT; 이전 DML명령어는 데이터베이스에 저장된다.   

<br><br><br>

# 세션과 읽기 일관성의 의미
## `세션이란?`
```
데이터 베이스에 접속-접속 종료까지의 기간을 의미
```
> 세션이 여러 개라는 건
```
데이터 베이스에 여러 사용자가 접속해 있다면
접속한 사용자마다 세션이 되는것
```
> 트랜잭션과 세션이 관계
```
트랜잭션은 하나 이상의 DML이 모인 작업 단위를 말하며
세션 내부에는 하나 이상의 트랜잭션이 존재한다.
    데이터 베이스에 접속후 종료하기까지 
        여러 트랜잭션이 진행되기 때문이다

세션이 트랜잭션보다 큰 개념이라는 것.
```

## `데이터 일관성의 중요성`
```
데이터 베이스는 동시에 접근하여 관리*사용하는것이 목적이고

수많은 세션이 동시에 연결이 되어있다.
특정 세션에서 테이블의 내용을 변경중일때
다른 세션이 그 변경중인 트랜잭션이 완료되기 전까지 알필요가 없으므로
`
조작전 본래의 데이터를 보여주는 특성을 말한다
`
```
> 데이터 조작 전 상태의 내용이 일관적으로 조회,출력,검색이 되는 특성   
```
`읽기 일관성(read consistency)`
```

# 수정 중인 데이터 접근을 막는 LOCK  

## `LOCK 이란?`   
```
특정 세션에서 조작중인 데이터는 트랜잭션이 완료(COMMIT,ROLLBACK)이 되기전까지
다른 세션에서 조작할수 없는 상태가 된다.
```
## `LOCK 개념` 
```
HANG이라는 개념

A 세션은 SQL Developer
B 세션은 SQL PLUS

A세션이 SCHOOL이라는 테이블을 UPDATE 후 트랜잭션을 마무리 안했다면.
B세션이 SCHOOL이라는 테이블을 UPDATE를 하면

A세션이 트랜잭션을 완료하기 전까지 B세션은 무한 대기상태가 된다.

여기서 주의할점

A 세션이 테이블1 ID=1 의 이름을 "둘리"라고 COMMIT을하고
B 세션이 테이블1 ID=1 의 이름을 "길동"이라고 수정하고 
                               트랜잭션을 완료안한상태라면

A세션과 B세션이 SELECT로 테이블1을 조회한다면
A세션은 읽기 일관성으로 ID=1인 이름이 "둘리"로 보이고
B세션은 트랜잭션이 진행중이기 때문에 이름이 "길동"으로 보인다
```
## `LOCK 종류`
```
A 세션이 테이블1 ID=1 의 이름을 다시 "둘리"라고 수정하면
B 세션은 ID=1인 행은 수정을 하려면 LOCK이걸려서 HANG상태로 가지만
        ID=1을 제외하고는 테이블 1을 수정할수가 있다.

```
>이렇게 특정테이블에 특정 행 데이터가 LOCK 걸린 상태를   
> 행 레벨 록(ROW LEVEL ROCK) 라고 정의한다.

```
특정 행을 지정하지 않고 테이블 전체 데이터를 수정하는 경우엔
UPDATE,DELETE가 WHERE를 지정하지 않았을 경우에는

전체행이 LOCK가 된다.
```
> DML명령어를 사용하여 데이터가 변경중인 테이블은 테이블 단위 잠금이라는 의미로   
테이블 레벨 록(table level lock)이라한다.
```
대신 데이터를 추가하는 INSERT문은 사용이 가능하다.
```


